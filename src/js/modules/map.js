const data = {
  type: 'FeatureCollection',
  features: [
    {
      type: 'Feature',
      id: 0,
      geometry: { type: 'Point', coordinates: [55.743637, 37.539134] },
      properties: {
        balloonContent: 'Красота и здоровье',
        position: 1,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/healing.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-50, -55],
      },
    },
    {
      type: 'Feature',
      id: 1,
      geometry: { type: 'Point', coordinates: [55.74444, 37.542721] },
      properties: {
        balloonContent: 'Отдых, развлечения',
        position: 5,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/tea.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-50, -35],
      },
    },
    {
      type: 'Feature',
      id: 2,
      geometry: { type: 'Point', coordinates: [55.745077, 37.545334] },
      properties: {
        balloonContent: 'Магазины',
        position: 2,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/market.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-50, -35],
      },
    },
    {
      type: 'Feature',
      id: 3,
      geometry: { type: 'Point', coordinates: [55.745657, 37.548101] },
      properties: {
        balloonContent: 'Обучение',
        position: 3,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/school.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 4,
      geometry: { type: 'Point', coordinates: [55.748794, 37.528822] },
      properties: {
        balloonContent: 'Отдых, развлечения',
        position: 5,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/tea.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 5,
      geometry: { type: 'Point', coordinates: [55.747965, 37.527297] },
      properties: {
        balloonContent: 'Магазины',
        position: 2,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/market.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 6,
      geometry: { type: 'Point', coordinates: [55.746465, 37.526724] },
      properties: {
        balloonContent: 'Обучение',
        position: 3,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/school.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 7,
      geometry: { type: 'Point', coordinates: [55.747076, 37.528197] },
      properties: {
        balloonContent: 'Отдых, развлечения',
        position: 5,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/movie.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 8,
      geometry: { type: 'Point', coordinates: [55.745863, 37.530984] },
      properties: {
        balloonContent: 'Красота и здоровье',
        position: 1,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/beauty.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 9,
      geometry: { type: 'Point', coordinates: [55.748576, 37.533789] },
      properties: {
        balloonContent: 'Магазины',
        position: 2,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/market.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 10,
      geometry: { type: 'Point', coordinates: [55.749336, 37.537838] },
      properties: {
        balloonContent: 'Магазины',
        position: 2,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/market.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 11,
      geometry: { type: 'Point', coordinates: [55.74758, 37.537067] },
      properties: {
        balloonContent: 'Красота и здоровье',
        position: 1,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/healing.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 12,
      geometry: { type: 'Point', coordinates: [55.747017, 37.535787] },
      properties: {
        balloonContent: 'Отдых, развлечения',
        position: 5,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/animal.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 13,
      geometry: { type: 'Point', coordinates: [55.747343, 37.541923] },
      properties: {
        balloonContent: 'Отдых, развлечения',
        position: 5,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/tea.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 14,
      geometry: { type: 'Point', coordinates: [55.748458, 37.539503] },
      properties: {
        balloonContent: 'Детсад',
        position: 4,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/baby.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 15,
      geometry: { type: 'Point', coordinates: [55.749464, 37.543535] },
      properties: {
        balloonContent: 'Детсад',
        position: 4,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/baby.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
    {
      type: 'Feature',
      id: 16,
      geometry: { type: 'Point', coordinates: [55.74681, 37.538609] },
      properties: {
        balloonContent: 'Детсад',
        position: 4,
      },
      options: {
        iconLayout: 'default#image',
        iconImageHref: 'http://localhost:4000/img/map/marker/baby.png',
        iconImageSize: [78, 93],
        iconImageOffset: [-40, -45],
      },
    },
  ],
}

ymaps.ready(init)

function init() {
  var myMap = new ymaps.Map('map', {
      center: [55.74660592958217, 37.5362368787333],
      zoom: 15,
      controls: [],
    }),
    objectManager = new ymaps.ObjectManager({
      clusterize: false,
      gridSize: 64,
      clusterIconLayout: 'default#pieChart',
    })

  objectManager.add(data)
  myMap.geoObjects.add(objectManager)

  const mapCategoryDiv = document.querySelector('.map__category')

  getPlaceMarkCategory(data).map(item =>
    mapCategoryDiv.insertAdjacentHTML(
      'beforeend',
      `<button
          class="category__item"
          data-category="${item.title}"
          data-checked="true"
        >
          ${item.title} <span>${item.count}</span>
        </button>`
    )
  )

  mapCategoryDiv.addEventListener('click', e => {
    const category = e.target.closest('.category__item').dataset.category
    const isChecked =
      e.target.closest('.category__item').dataset.checked === 'true'
        ? true
        : false

    if (isChecked) {
      e.target.closest('.category__item').dataset.checked = false
      objectManager.remove(getPlaceMarkByCategory(data, category))
    } else {
      e.target.closest('.category__item').dataset.checked = true
      objectManager.add(getPlaceMarkByCategory(data, category))
    }
  })
}

function getPlaceMarkCategoryAll(data) {
  return data.features.map(item => ({
    title: item.properties.balloonContent,
    position: item.properties.position,
    count: data.features.filter(
      mark => mark.properties.balloonContent === item.properties.balloonContent
    ).length,
  }))
}

function getPlaceMarkCategory(data) {
  return getPlaceMarkCategoryAll(data)
    .reduce(
      (acc, item) => {
        if (acc.map[item.title]) return acc

        acc.map[item.title] = true
        acc.result.push(item)
        return acc
      },
      {
        map: {},
        result: [],
      }
    )
    .result.sort((a, b) => (a.position > b.position ? 1 : -1))
}

function getPlaceMarkByCategory(data, category) {
  const find = data.features.filter(
    item => item.properties.balloonContent === category
  )

  return { type: 'FeatureCollection', features: find }
}
